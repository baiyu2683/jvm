# 虚拟机类加载机制

## 概述

java虚拟机把描述类的数据从Class文件加载道内存，并对数据进行校验、转换解析和初始化，最终形成可以被虚拟机直接使用的Java类型，这个过程被称作虚拟机的类加载机制。类型的加载、链接和初始化过程都是在程序运行期间完成的。

## 类加载的时机

![image-20210104164234535](/home/cellophane/.config/Typora/typora-user-images/image-20210104164234535.png)

![image-20210104164645448](/home/cellophane/.config/Typora/typora-user-images/image-20210104164645448.png)

![image-20210104164739998](/home/cellophane/.config/Typora/typora-user-images/image-20210104164739998.png)



​		接口也有初始化过程,这点与类是一致的,上面的代码都是用静态语句块“static{}”来输出初始化信息的,而接口中不能使用“static{}”语句块,但编译器仍然会为接口生成“<clinit>()”类构造器[2] ,用于初始化接口中所定义的成员变量。**接口与类真正有所区别的是前面讲述的六种“有且仅有”需要触发初始化场景中的第三种:当一个类在初始化时,要求其父类全部都已经初始化过了,但是一个接口在初始化时,并不要求其父接口全部都完成了初始化,只有在真正使用到父接口的时候(如引用接口中定义的常量)才会初始化。**



## 类加载的过程

### 加载

![image-20210104165916565](/home/cellophane/.config/Typora/typora-user-images/image-20210104165916565.png)

![image-20210104170655189](/home/cellophane/.config/Typora/typora-user-images/image-20210104170655189.png)



​	![image-20210104170932596](/home/cellophane/.config/Typora/typora-user-images/image-20210104170932596.png)

### 验证

验证是链接阶段的第一步，这一阶段的目的是确保Class文件的字节流中包含的信息符合java虚拟机规范的全部约束要求，保证这些信息被当作代码运行后不会危害虚拟机自身的安全。

#### 文件格式验证

![image-20210104171300767](/home/cellophane/.config/Typora/typora-user-images/image-20210104171300767.png)

#### 元数据验证

![image-20210104171408684](/home/cellophane/.config/Typora/typora-user-images/image-20210104171408684.png)



#### 字节码验证

![image-20210104171639234](/home/cellophane/.config/Typora/typora-user-images/image-20210104171639234.png)

#### 符号引用验证

![image-20210104172314731](/home/cellophane/.config/Typora/typora-user-images/image-20210104172314731.png)

### 准备

**准备阶段是正式为类中定义的变量（即静态变量，被static修饰的变量）分配内存并设置类变量初始值的阶段。**



![image-20210104173219537](/home/cellophane/.config/Typora/typora-user-images/image-20210104173219537.png)

### 解析

![image-20210104173450056](/home/cellophane/.config/Typora/typora-user-images/image-20210104173450056.png)

### 初始化

![image-20210104180246507](/home/cellophane/.config/Typora/typora-user-images/image-20210104180246507.png)

![image-20210104180301096](/home/cellophane/.config/Typora/typora-user-images/image-20210104180301096.png)

![image-20210104180312818](/home/cellophane/.config/Typora/typora-user-images/image-20210104180312818.png)

![image-20210104180328494](/home/cellophane/.config/Typora/typora-user-images/image-20210104180328494.png)

## 类与类加载器



## 双亲委派

![image-20210105152149438](/home/cellophane/.config/Typora/typora-user-images/image-20210105152149438.png)

![image-20210105152801523](/home/cellophane/.config/Typora/typora-user-images/image-20210105152801523.png)

![image-20210105152827864](/home/cellophane/.config/Typora/typora-user-images/image-20210105152827864.png)



### 模块化下的类加载器



![image-20210105155636093](/home/cellophane/.config/Typora/typora-user-images/image-20210105155636093.png)

![image-20210105155849697](/home/cellophane/.config/Typora/typora-user-images/image-20210105155849697.png)

![image-20210105155911738](/home/cellophane/.config/Typora/typora-user-images/image-20210105155911738.png)

![image-20210105155947412](/home/cellophane/.config/Typora/typora-user-images/image-20210105155947412.png)